import { Callout } from "@doc";
import { createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Permissions | thirdweb Engine",
	description: "Manage dashboard and API access to your Engine instance.",
});

# Permissions

Manage [dashboard](https://thirdweb.com/dashboard/engine) and [API](engine/references/api) access to your Engine instance.

## Dashboard access

Grant dashboard access to your Engine instance.

1. Navigate to the [Engine dashboard page](https://thirdweb.com/dashboard/engine).
1. Select the **Permissions** tab.
1. Under **Admins**, select **Add New Admin**.
1. Provide the wallet address owned by the user to add.

The user with this wallet address can now manage your Engine instance.

> The `ADMIN_WALLET_ADDRESS` the always an admin user.

## API access

### Long-lived access tokens

Grant API access to your Engine instance with long-lived access tokens.

##### Create an access token

1. Navigate to the [thirdweb dashboard](https://thirdweb.com/dashboard/engine).
1. Select the **Permissions** tab.
1. Under **Access Tokens**, select **Create Access Token**.

Provide the header `Authorization: Bearer <access_token>` when calling the Engine API.

<Callout title="An access token is only shown once!" variant="warning">

Securely store access tokens and revoke them if they are compromised.

</Callout>

##### Revoke an access token

1. Navigate to the [thirdweb dashboard](https://thirdweb.com/dashboard/engine).
1. Select the **Permissions** tab.
1. Under **Access Tokens**, find the access token to revoke and select **Delete**.

### Advanced: Temporary access tokens

Alternatively, Engine allows authenticating with a short-lived JWT signature to ensure access tokens cannot be reused after expiration. These access tokens **must expire within 15 minutes**.

##### 1. Generate a keypair

Generate an ES256 keypair in your terminal with `openssl`:

```bash
openssl ecparam -name prime256v1 -genkey -noout -out private.key
openssl ec -in private.key -pubout -out public.key
```

Your private key (`private.key`) will begin with:

```text
-----BEGIN EC PRIVATE KEY-----
```

Your public key (`public.key`) will begin with:

```text
-----BEGIN PUBLIC KEY-----
```

Alternatively, generate your keypair with NodeJS:

```typescript
import crypto from "crypto";

const { publicKey, privateKey } = crypto.generateKeyPairSync("ec", {
	namedCurve: "P-256",
	publicKeyEncoding: {
		type: "spki",
		format: "pem",
	},
	privateKeyEncoding: {
		type: "pkcs8",
		format: "pem",
	},
});
```

##### 2. Configure Engine with your public key

Set the `KEYPAIR_PUBLIC_KEY` environment variable when hosting Engine:

```
# Example .env file
KEYPAIR_PUBLIC_KEY="-----BEGIN PUBLIC KEY-----
...
-----END PUBLIC KEY-----"
```

##### 3. Sign a JWT with your private key

This step must be done on each request.

```typescript
import jsonwebtoken from "jsonwebtoken";

const payload = {
	iss: "", // Unused
	aud: "thirdweb.com", // Must be set to thirdweb.com
};
const privateKey = fs.readFileSync("private.key");
const keypairJwt = jsonwebtoken.sign(payload, privateKey, {
	algorithm: "ES256",
	expiresIn: "15s", // Invalidate after 15 seconds
});
```

##### 4. Authenticate Engine requests with this JWT

```typescript
const resp = fetch(`${engineBaseUrl}/backend-wallet/84532/transfer`, {
	method: "POST",
	headers: {
		"content-type": "application/json",
		authorization: `Bearer ${keypairJwt}`,
		"x-backend-wallet-address": backendWalletAddress,
	},
	body: JSON.stringify({ to, amount }),
});
```
